name: CI

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright Browser (required for Vitest browser project)
        run: bunx playwright install --with-deps chromium

      - name: Package Quality Checks
        run: bun run check

  consumer-matrix:
    name: Consumer Matrix (${{ matrix.consumer.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        consumer:
          - name: react
            setup: demo:setup:react
            build: demo:build:react
          - name: vue
            setup: demo:setup:vue
            build: demo:build:vue
          - name: svelte
            setup: demo:setup:svelte
            build: demo:build:svelte
          - name: next
            setup: demo:setup:next
            build: demo:build:next
          - name: tanstack
            setup: demo:setup:tanstack
            build: demo:build:tanstack

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build Package
        run: bun run build

      - name: Install Consumer Dependencies
        run: bun run ${{ matrix.consumer.setup }}

      - name: Build Consumer
        run: bun run ${{ matrix.consumer.build }}

      - name: Smoke Consumer
        run: DEMO_SMOKE_CONSUMER=${{ matrix.consumer.name }} bun run test:smoke

  storybook-changes:
    name: Detect Storybook Changes
    runs-on: ubuntu-latest
    outputs:
      storybook: ${{ steps.filter.outputs.storybook }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            storybook:
              - '.storybook/**'
              - 'src/stories/**'
              - 'src/**/*.stories.ts'
              - 'src/**/*.stories.tsx'
              - 'src/**/*.stories.mdx'
              - 'package.json'
              - 'bun.lock'

  chromatic:
    name: Run Chromatic
    runs-on: ubuntu-latest
    needs:
      - quality
      - consumer-matrix
      - storybook-changes
    if: ${{ needs.storybook-changes.outputs.storybook == 'true' }}
    env:
      CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24.13.0

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Storybook
        run: bun run build-storybook

      - name: Run Chromatic
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
        uses: chromaui/action@a8ce9c58f59be5cc7090cadfc8f130fb08fcf0c3 # v15.1.0
        with:
          projectToken: ${{ env.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: storybook-static
          onlyChanged: true
          exitZeroOnChanges: true

      - name: Missing Chromatic token
        if: ${{ env.CHROMATIC_PROJECT_TOKEN == '' }}
        run: |
          echo "CHROMATIC_PROJECT_TOKEN is not configured."
          echo "Add it in GitHub repository settings > Secrets and variables > Actions."
          exit 1
